name: Full CI/CD

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Set paths
      - name: âš™ï¸ Set environment paths
        run: |
          BRANCH=${GITHUB_REF##*/}
          echo "Branch: $BRANCH"

          echo "FRONTEND_PATH=$GITHUB_WORKSPACE/frontend-react" >> $GITHUB_ENV
          echo "BACKEND_PATH=$GITHUB_WORKSPACE/backend-node" >> $GITHUB_ENV

          if [ "$BRANCH" = "dev" ]; then
            echo "DEPLOY_DIR=/var/www/app-dev" >> $GITHUB_ENV
            echo "BACKEND_SERVICE=backend-dev.service" >> $GITHUB_ENV
          elif [ "$BRANCH" = "main" ]; then
            echo "DEPLOY_DIR=/var/www/app-prod" >> $GITHUB_ENV
            echo "BACKEND_SERVICE=backend-prod.service" >> $GITHUB_ENV
          fi

      # Frontend
      - name: ğŸ“¦ Frontend install
        run: |
          cd $FRONTEND_PATH
          npm install

      - name: ğŸ—ï¸ Build frontend
        run: |
          cd $FRONTEND_PATH
          npm run build

      - name: ğŸš€ Deploy frontend
        run: |
          sudo rm -rf $DEPLOY_DIR/*
          sudo cp -r $FRONTEND_PATH/dist/* $DEPLOY_DIR/
          sudo systemctl reload nginx
          sudo ls -lah $DEPLOY_DIR

      # Backend
      - name: ğŸš€ Restart backend service
        run: |
          echo "Restarting backend systemd service: $BACKEND_SERVICE"
          sudo systemctl restart $BACKEND_SERVICE
          sudo systemctl status $BACKEND_SERVICE --no-pager
