name: Full CI/CD

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # =============================
      # Checkout repository
      # =============================
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v3

      # =============================
      # Setup Node.js
      # =============================
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # =============================
      # Detect branch and set paths
      # =============================
      - name: âš™ï¸ Set environment paths
        run: |
          BRANCH=${GITHUB_REF##*/}
          echo "Detected branch: $BRANCH"

          if [ "$BRANCH" = "dev" ]; then
            export FRONTEND_PATH="$GITHUB_WORKSPACE/frontend-react"
            export BACKEND_PATH="$GITHUB_WORKSPACE/backend-node"
            export DEPLOY_DIR="/var/www/app-dev"
            export BACKEND_LOG="/var/www/backend-dev.log"
            echo "âœ… DEV environment selected (port 81)"
          elif [ "$BRANCH" = "main" ]; then
            export FRONTEND_PATH="$GITHUB_WORKSPACE/frontend-react"
            export BACKEND_PATH="$GITHUB_WORKSPACE/backend-node"
            export DEPLOY_DIR="/var/www/app-prod"
            export BACKEND_LOG="/var/www/backend-prod.log"
            echo "âœ… PROD environment selected (port 80)"
          else
            echo "âŒ Branch not recognized, exiting..."
            exit 1
          fi

          echo "Frontend folder: $FRONTEND_PATH"
          echo "Backend folder: $BACKEND_PATH"
          echo "Deploy folder: $DEPLOY_DIR"
          echo "Backend log file: $BACKEND_LOG"

      # =============================
      # Frontend: Install dependencies
      # =============================
      - name: ðŸ“¦ Install frontend dependencies
        run: |
          echo "ðŸ“‚ Current directory: $(pwd)"
          echo "âž¡ï¸ Installing frontend dependencies..."
          cd $FRONTEND_PATH || exit
          echo "ðŸ“‚ Now in frontend folder: $(pwd)"
          npm install
          echo "âœ… Frontend dependencies installed"

      # =============================
      # Frontend: Build
      # =============================
      - name: ðŸ—ï¸ Build frontend
        run: |
          echo "âž¡ï¸ Building frontend..."
          cd $FRONTEND_PATH || exit
          npm run build
          echo "âœ… Frontend build completed. Dist folder contents:"
          ls -lah dist

      # =============================
      # Deploy Frontend
      # =============================
      - name: ðŸš€ Deploy frontend
        run: |
          echo "âž¡ï¸ Deploying frontend to $DEPLOY_DIR..."
          sudo rm -rf $DEPLOY_DIR/*
          sudo cp -r $FRONTEND_PATH/dist/* $DEPLOY_DIR/
          echo "âœ… Frontend deployed to $DEPLOY_DIR"
          echo "âž¡ï¸ Reloading Nginx..."
          sudo systemctl reload nginx
          echo "âœ… Nginx reloaded successfully"

      # =============================
      # Backend: Deploy & Start
      # =============================
      - name: ðŸš€ Deploy backend
        run: |
          echo "âž¡ï¸ Deploying backend from $BACKEND_PATH..."
          sudo fuser -k 5000/tcp 2>/dev/null || echo "No process running on 5000"
          cd $BACKEND_PATH || exit
          echo "ðŸ“‚ Now in backend folder: $(pwd)"
          npm install
          echo "âž¡ï¸ Starting backend..."
          nohup npm start > $BACKEND_LOG 2>&1 &
          echo "âœ… Backend started. Logs: $BACKEND_LOG"
