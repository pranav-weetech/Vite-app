name: Backend-dev

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # ==================================
      # Detect branch + set environment
      # ==================================
      - name: âš™ï¸ Set environment paths
        run: |
          BRANCH=$GITHUB_REF_NAME
          echo "Detected branch: $BRANCH"

          echo "BACKEND_PATH=$GITHUB_WORKSPACE/backend-node" >> $GITHUB_ENV

          if [ "$BRANCH" = "dev" ]; then
            echo "BACKEND_SERVICE=backend-dev.service" >> $GITHUB_ENV
          elif [ "$BRANCH" = "main" ]; then
            echo "BACKEND_SERVICE=backend-prod.service" >> $GITHUB_ENV
          else
            echo "Unknown branch: $BRANCH"
            exit 1
          fi

          echo "Environment set."
          echo "BACKEND_PATH=$BACKEND_PATH"
          echo "BACKEND_SERVICE=$BACKEND_SERVICE"

      # ==================================
      # Backend build (install only)
      # ==================================
      - name: ðŸ“¦ Install backend dependencies
        run: |
          echo "Installing backend dependencies..."
          cd $BACKEND_PATH
          npm install

      # ==================================
      # Restart backend
      # ==================================
      - name: ðŸš€ Restart backend service
        run: |
          echo "Restarting backend systemd service: $BACKEND_SERVICE"
          sudo systemctl stop $BACKEND_SERVICE || true
          sudo systemctl start $BACKEND_SERVICE
          sudo systemctl status $BACKEND_SERVICE --no-pager

