name: Full CI/CD

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # ==========================
      # FRONTEND
      # ==========================
      - name: Install frontend deps
        working-directory: ./frontend-react
        run: npm install

      - name: Build frontend
        working-directory: ./frontend-react
        run: npm run build

      # DEV deploy
      - name: Deploy DEV frontend
        if: github.ref == 'refs/heads/dev'
        run: |
          sudo rm -rf /var/www/app-dev/*
          sudo cp -r frontend-react/dist/* /var/www/app-dev/
          sudo systemctl restart nginx

      # PROD deploy
      - name: Deploy PROD frontend
        if: github.ref == 'refs/heads/main'
        run: |
          sudo rm -rf /var/www/app-prod/*
          sudo cp -r frontend-react/dist/* /var/www/app-prod/
          sudo systemctl restart nginx

      # ==========================
      # BACKEND
      # ==========================
      - name: Install backend deps
        working-directory: ./backend-node
        run: npm install

      - name: Restart backend service
        run: |
          pkill node || true
          nohup node /home/ubuntu/Vite-app/backend-node/index.js > /home/ubuntu/backend.log 2>&1 &
          echo "Backend restarted"
